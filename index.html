<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>RT Sales Trainer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Corporate Colors */
        :root {
            --rt-violet: #7F00FF;    
            --rt-dark: #1D1F26;      
            --rt-orange: #FF7A00;    
            --bg-page: #F3F4F6;
        }

        body { 
            background-color: var(--bg-page); 
            color: #1F2937; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
        }

        /* Branding Header */
        .rt-header {
            background: white; 
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .card-shadow {
            box-shadow: 0 4px 20px rgba(127, 0, 255, 0.08);
        }

        /* Animations */
        .fly-out-left { animation: flyOutLeft 0.5s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
        .fly-out-right { animation: flyOutRight 0.5s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }
        
        @keyframes flyOutLeft { to { transform: translateX(-120%) rotate(-10deg); opacity: 0; } }
        @keyframes flyOutRight { to { transform: translateX(120%) rotate(10deg); opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Recording Pulse */
        .recording-pulse { animation: pulse-violet 1.5s infinite; background-color: #F3E8FF !important; border-color: var(--rt-violet) !important; }
        @keyframes pulse-violet {
            0% { box-shadow: 0 0 0 0 rgba(127, 0, 255, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(127, 0, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(127, 0, 255, 0); }
        }

        audio { height: 40px; width: 100%; border-radius: 8px; margin-top: 8px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05)); }
        .hidden { display: none !important; }
        
        /* Bottom Nav */
        .nav-btn.active { color: var(--rt-violet); }
        .nav-btn.active i { transform: scale(1.1); transition: transform 0.2s; }
        .nav-btn { transition: all 0.2s; color: #9CA3AF; }
        
        /* Onboarding Overlay */
        .overlay-bg {
            background: rgba(29, 31, 38, 0.98); 
            backdrop-filter: blur(5px);
        }
        .step-dot { transition: all 0.3s; }
        .step-dot.active { background-color: var(--rt-violet); width: 24px; }

        input { outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--rt-violet); }

    </style>
</head>
<body class="h-screen w-full flex flex-col relative">

    <!-- MAIN MENU (START PAGE) -->
    <div id="view-menu" class="absolute inset-0 z-40 bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-10 animate-bounce">
            <div class="w-28 h-28 rounded-full bg-[#7F00FF]/10 flex items-center justify-center border-2 border-[#7F00FF]/20">
                <i class="fas fa-graduation-cap text-5xl text-[#7F00FF]"></i>
            </div>
        </div>
        
        <h1 class="text-3xl font-extrabold text-[#1D1F26] mb-2">Онлайн Университет</h1>
        <div class="inline-block px-3 py-1 bg-[#FF7A00] text-white text-xs font-bold rounded-full mb-8 uppercase tracking-widest">B2C Тренажер</div>
        
        <p class="text-gray-400 text-sm max-w-xs mb-12">Отрабатывай возражения, соревнуйся с коллегами и прокачивай навыки продаж.</p>

        <button onclick="checkRegistrationAndStart()" class="w-full max-w-xs py-4 bg-[#7F00FF] rounded-xl font-bold uppercase tracking-wider text-white shadow-lg shadow-purple-200 hover:bg-purple-600 transition-all mb-4">
            Начать игру
        </button>
        
        <button onclick="showLeaderboardFromMenu()" class="w-full max-w-xs py-4 bg-gray-100 rounded-xl font-bold uppercase tracking-wider text-gray-500 hover:bg-gray-200 transition-all">
            Рейтинг
        </button>
    </div>

    <!-- ONBOARDING (INSTRUCTION) -->
    <div id="onboarding" class="absolute inset-0 z-50 overlay-bg flex flex-col items-center justify-center p-8 text-white hidden">
        <div class="w-full max-w-sm flex flex-col items-center text-center">
            
            <!-- Slide 1 -->
            <div class="onboarding-step fade-in" id="step-1">
                <div class="w-24 h-24 rounded-full bg-[#7F00FF]/20 flex items-center justify-center mb-6 mx-auto border border-[#7F00FF]/40">
                    <i class="fas fa-gavel text-4xl text-[#7F00FF]"></i>
                </div>
                <h2 class="text-2xl font-bold mb-3">Голосование</h2>
                <p class="text-white/70 text-sm leading-relaxed mb-8">
                    Слушай ответы коллег и выбирай, кто отработал возражение убедительнее.
                </p>
            </div>

            <!-- Slide 2 -->
            <div class="onboarding-step hidden fade-in" id="step-2">
                <div class="w-24 h-24 rounded-full bg-white/10 flex items-center justify-center mb-6 mx-auto border border-white/20">
                    <i class="fas fa-microphone text-4xl text-[#FF7A00]"></i>
                </div>
                <h2 class="text-2xl font-bold mb-3">Запись</h2>
                <p class="text-white/70 text-sm leading-relaxed mb-8">
                    Получи кейс клиента и запиши свой ответ. Лучшие попадут в рейтинг недели.
                </p>
            </div>

            <!-- Dots -->
            <div class="flex gap-2 mb-8">
                <div class="h-2 w-2 rounded-full bg-white/30 step-dot active" id="dot-1"></div>
                <div class="h-2 w-2 rounded-full bg-white/30 step-dot" id="dot-2"></div>
            </div>

            <button onclick="nextStep()" id="onboarding-btn" class="w-full py-4 bg-[#7F00FF] rounded-xl font-bold uppercase tracking-wider shadow-lg hover:bg-purple-600 transition-colors">
                Далее
            </button>
        </div>
    </div>

    <!-- REGISTRATION FORM -->
    <div id="view-registration" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 hidden">
        <div class="w-full max-w-sm slide-up">
            <h2 class="text-2xl font-bold text-[#1D1F26] mb-2 text-center">Знакомство</h2>
            <p class="text-gray-400 text-sm text-center mb-8">Введите данные для отображения в рейтинге</p>

            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Ваш Город</label>
                <input type="text" id="reg-city" placeholder="Москва" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-[#1D1F26] font-medium">
            </div>

            <div class="mb-8">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Рабочая почта</label>
                <input type="email" id="reg-email" placeholder="name@rt.ru" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-[#1D1F26] font-medium">
                <p class="text-[10px] text-gray-300 mt-2 text-center">* Почта не будет видна другим пользователям</p>
            </div>

            <button onclick="submitRegistration()" class="w-full py-4 bg-[#FF7A00] rounded-xl font-bold uppercase tracking-wider text-white shadow-lg shadow-orange-200 hover:bg-orange-600 transition-all">
                Продолжить
            </button>
        </div>
    </div>

    <!-- MAIN APP INTERFACE (HIDDEN BY DEFAULT) -->
    <div id="app-container" class="hidden h-full flex flex-col">
        <!-- Header -->
        <div class="rt-header pt-4 pb-3 px-4 shadow-sm z-20 relative">
            <div class="flex justify-between items-center mb-4">
                <!-- IMAGE LOGO -->
                <div class="flex items-center cursor-pointer" onclick="showMenu()">
                    <img src="./logo.png" alt="Онлайн Университет B2C" class="h-10 w-auto object-contain">
                </div>
                <div class="bg-gray-100 px-3 py-1.5 rounded-lg">
                    <span class="text-[10px] font-bold text-[#7F00FF] uppercase" id="step-label">...</span>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full h-1 bg-gray-200 rounded-full overflow-hidden mb-1">
                <div id="progress-line" class="h-full bg-[#7F00FF] w-0 transition-all duration-500 rounded-full"></div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 relative overflow-hidden bg-[#F3F4F6]">
            
            <!-- VIEW: VOTING (BATTLE) -->
            <div id="view-vote" class="absolute inset-0 flex flex-col p-4 pb-24 hidden fade-in overflow-y-auto">
                <div class="text-center text-[10px] text-gray-400 font-bold mb-3 mt-2 uppercase tracking-widest">
                    Раунд <span id="vote-counter" class="text-[#1D1F26] text-sm">1</span> / <span id="vote-total">3</span>
                </div>

                <div class="flex-1 flex flex-col gap-4 relative justify-center">
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-30 pointer-events-none">
                        <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center border-4 border-[#F3F4F6] shadow-xl text-sm font-black text-[#7F00FF] italic">VS</div>
                    </div>

                    <!-- Card 1 -->
                    <div id="card-1" class="flex-1 bg-white rounded-2xl p-5 flex flex-col justify-between transition-all duration-300 card-shadow border-l-4 border-[#7F00FF] relative">
                        <div class="mb-2">
                            <div class="text-[9px] text-[#7F00FF] uppercase font-bold tracking-widest opacity-60">Возражение</div>
                            <div class="text-sm font-bold text-gray-800 leading-tight mt-1" id="topic-1">...</div>
                        </div>
                        <div class="flex flex-col items-center w-full">
                            <audio id="audio-1" controls preload="none"></audio>
                            <button onclick="vote(0)" class="mt-4 w-full py-3 bg-[#F3E8FF] rounded-xl font-bold text-[10px] text-[#7F00FF] hover:bg-[#7F00FF] hover:text-white uppercase tracking-wider transition-all">Выбрать</button>
                        </div>
                    </div>

                    <!-- Card 2 -->
                    <div id="card-2" class="flex-1 bg-white rounded-2xl p-5 flex flex-col justify-between transition-all duration-300 card-shadow border-l-4 border-[#FF7A00] relative">
                        <div class="flex flex-col items-center w-full order-2">
                            <button onclick="vote(1)" class="mb-4 w-full py-3 bg-[#FFF7ED] rounded-xl font-bold text-[10px] text-[#FF7A00] hover:bg-[#FF7A00] hover:text-white uppercase tracking-wider transition-all">Выбрать</button>
                            <audio id="audio-2" controls preload="none"></audio>
                        </div>
                        <div class="mb-2 order-1 border-b border-gray-100 pb-2">
                            <div class="text-[9px] text-[#FF7A00] uppercase font-bold tracking-widest opacity-60">Возражение</div>
                            <div class="text-sm font-bold text-gray-800 leading-tight mt-1" id="topic-2">...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: RECORDING -->
            <div id="view-record" class="absolute inset-0 flex flex-col p-6 pb-24 hidden fade-in justify-center items-center text-center">
                <div class="bg-white w-full p-8 rounded-3xl card-shadow relative overflow-hidden mb-10 border border-white/50">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-[#7F00FF] to-[#FF7A00]"></div>
                    <div class="inline-block px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-[9px] font-bold uppercase tracking-widest mb-4">Ваш ход</div>
                    <div class="text-[10px] text-gray-400 mb-2 uppercase tracking-wide">Клиент говорит:</div>
                    <p class="text-xl font-serif italic text-[#1D1F26] leading-relaxed" id="scenario-text">"..."</p>
                </div>
                <div class="relative">
                    <button id="record-btn" class="w-24 h-24 rounded-full bg-gradient-to-br from-[#7F00FF] to-[#6002EE] flex items-center justify-center shadow-xl shadow-purple-500/30 text-white active:scale-95 transition-transform z-10 relative border-4 border-[#F3F4F6]">
                        <i class="fas fa-microphone text-3xl" id="mic-icon"></i>
                    </button>
                    <div class="mt-6 text-3xl font-mono text-[#1D1F26] font-bold hidden" id="recording-timer">00:00</div>
                    <p class="mt-4 text-xs text-gray-400 max-w-[200px]" id="rec-hint">Нажмите микрофон</p>
                </div>
            </div>

            <!-- VIEW: LEADERBOARD -->
            <div id="view-leaderboard" class="absolute inset-0 flex flex-col p-4 pb-24 hidden fade-in">
                <h2 class="text-lg font-bold text-[#1D1F26] mb-4 pl-2 flex items-center gap-2">
                    <i class="fas fa-chart-line text-[#7F00FF]"></i> Топ сотрудников
                </h2>
                <div class="flex-1 overflow-y-auto pr-1 space-y-3 pb-4" id="leaders-list"></div>
                <button onclick="showMenu()" class="mt-4 w-full py-3 bg-white border border-gray-200 rounded-xl text-gray-500 text-xs font-bold uppercase">В меню</button>
            </div>

            <!-- VIEW: SUCCESS -->
            <div id="view-success" class="absolute inset-0 flex flex-col justify-center items-center p-6 hidden fade-in z-30 bg-white/95 backdrop-blur-md">
                <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mb-6 shadow-lg shadow-green-500/20">
                    <i class="fas fa-check text-4xl text-green-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-[#1D1F26] mb-2">Принято!</h2>
                <p class="text-gray-500 text-center px-4 leading-relaxed mb-8 text-sm">Ваш ответ сохранен.</p>
                <button onclick="finishGame()" class="px-8 py-4 bg-[#7F00FF] rounded-xl text-white font-bold shadow-lg w-full max-w-xs uppercase text-xs tracking-widest hover:bg-[#6002EE] transition-colors">К рейтингу</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="absolute bottom-6 left-6 right-6 h-16 bg-white rounded-2xl card-shadow flex items-center justify-around z-40" id="bottom-menu">
            <button id="nav-battle" class="nav-btn active flex flex-col items-center gap-1 w-16">
                <i class="fas fa-gavel text-lg"></i>
                <span class="text-[9px] font-bold uppercase tracking-wide">Голоса</span>
            </button>
            <div class="relative -top-6">
                <button id="nav-record" class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center shadow-inner border-4 border-[#F3F4F6] text-gray-300 cursor-not-allowed transition-all">
                    <i class="fas fa-microphone text-xl"></i>
                </button>
            </div>
            <button id="nav-leaders" class="nav-btn text-gray-300 cursor-not-allowed flex flex-col items-center gap-1 w-16">
                <i class="fas fa-chart-pie text-lg"></i>
                <span class="text-[9px] font-bold uppercase tracking-wide">Рейтинг</span>
            </button>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center hidden">
        <div class="w-10 h-10 border-4 border-gray-100 border-t-[#7F00FF] rounded-full animate-spin mb-4"></div>
        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Загрузка...</div>
    </div>

    <script>
        // --- CONFIG ---
        // ВАЖНО: ВСТАВЬТЕ СЮДА ВАШУ ССЫЛКУ!
        const API_URL = 'https://functions.yandexcloud.net/d4e6md232ujcf62olr4o'; 
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const SCENARIOS = [
            "У нас уже подключен другой провайдер, нас всё устраивает.",
            "Мне не нужно телевидение, я смотрю только YouTube.",
            "В Ростелекоме дорого, я видел тарифы дешевле.",
            "Не хочу тянуть лишние провода по свежему ремонту.",
            "Слышал плохие отзывы о вашей техподдержке.",
            "Мне нужна только сим-карта, интернет дома не нужен.",
            "Я подумаю, оставьте буклет в двери."
        ];

        const VOTES_REQUIRED = 3; 
        let votesDone = 0;
        let gameState = 'menu'; 
        let currentRecords = [];
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let timerInterval;
        let currentScenarioText = "";
        let onboardingStep = 1;
        
        // User Data
        let userCity = "";
        let userEmail = "";

        // --- NAVIGATION LOGIC ---

        function showMenu() {
            gameState = 'menu';
            document.getElementById('view-menu').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }

        function checkRegistrationAndStart() {
            // Check if user has registered before
            const savedCity = localStorage.getItem('rt_user_city');
            const savedEmail = localStorage.getItem('rt_user_email');
            
            if (savedCity && savedEmail) {
                userCity = savedCity;
                userEmail = savedEmail;
                startGame();
            } else {
                // Show Onboarding then Registration
                document.getElementById('view-menu').classList.add('hidden');
                document.getElementById('onboarding').classList.remove('hidden');
            }
        }

        function nextStep() {
            document.getElementById(`step-${onboardingStep}`).classList.add('hidden');
            document.getElementById(`dot-${onboardingStep}`).classList.remove('active');
            onboardingStep++;
            if (onboardingStep > 2) {
                // Go to Registration
                document.getElementById('onboarding').classList.add('hidden');
                document.getElementById('view-registration').classList.remove('hidden');
            } else {
                document.getElementById(`step-${onboardingStep}`).classList.remove('hidden');
                document.getElementById(`dot-${onboardingStep}`).classList.add('active');
                if(onboardingStep === 2) document.getElementById('onboarding-btn').innerText = "НАЧАТЬ";
            }
        }

        function submitRegistration() {
            const cityInput = document.getElementById('reg-city').value.trim();
            const emailInput = document.getElementById('reg-email').value.trim();

            if (!cityInput || !emailInput) {
                tg.showAlert("Пожалуйста, заполните город и почту");
                return;
            }

            userCity = cityInput;
            userEmail = emailInput;
            localStorage.setItem('rt_user_city', userCity);
            localStorage.setItem('rt_user_email', userEmail);

            document.getElementById('view-registration').classList.add('hidden');
            startGame();
        }

        function startGame() {
            document.getElementById('view-menu').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            votesDone = 0;
            gameState = 'voting';
            updateUI();
            loadBattle();
        }

        function showLeaderboardFromMenu() {
            document.getElementById('view-menu').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            gameState = 'finished';
            updateUI();
            loadLeaderboard();
        }

        // --- GAME LOGIC ---

        document.addEventListener('play', function(e){
            var audios = document.getElementsByTagName('audio');
            for(var i = 0, len = audios.length; i < len;i++){
                if(audios[i] != e.target) {
                    audios[i].pause();
                }
            }
        }, true);

        function updateUI() {
            const progressBar = document.getElementById('progress-line');
            const stepLabel = document.getElementById('step-label');
            const navBattle = document.getElementById('nav-battle');
            const navRecord = document.getElementById('nav-record');
            const navLeaders = document.getElementById('nav-leaders');

            navRecord.onclick = null;
            navBattle.onclick = null;
            navLeaders.onclick = null;

            if (gameState === 'voting') {
                stepLabel.innerText = "Голосование";
                stepLabel.className = "text-[10px] font-bold text-[#7F00FF] uppercase";
                let percent = (votesDone / VOTES_REQUIRED) * 50;
                progressBar.style.width = `${percent}%`;
                document.getElementById('vote-counter').innerText = votesDone + 1;
                document.getElementById('vote-total').innerText = VOTES_REQUIRED;
                setNavState(navBattle, true);
                setNavState(navRecord, false, true);
                setNavState(navLeaders, false);
            } else if (gameState === 'recording') {
                stepLabel.innerText = "Ваш ответ";
                stepLabel.className = "text-[10px] font-bold text-[#FF7A00] uppercase";
                progressBar.style.width = "75%";
                setNavState(navBattle, false);
                setNavState(navRecord, true, true);
                setNavState(navLeaders, false);
                startScenarioMode();
            } else if (gameState === 'finished') {
                stepLabel.innerText = "Результаты";
                stepLabel.className = "text-[10px] font-bold text-green-500 uppercase";
                progressBar.style.width = "100%";
                setNavState(navBattle, false);
                setNavState(navRecord, false, true);
                setNavState(navLeaders, true);
                // Allow switching back to battle if coming from menu
                navLeaders.classList.add('active');
            }
        }

        function setNavState(el, isActive, isCenter = false) {
            el.classList.remove('active', 'text-gray-300', 'cursor-not-allowed', 'bg-gray-100', 'text-gray-400');
            if (isCenter) {
                if (isActive) {
                    el.className = "w-14 h-14 rounded-full bg-[#7F00FF] flex items-center justify-center shadow-lg shadow-purple-900/30 border-4 border-[#F3F4F6] text-white hover:scale-105 transition-transform cursor-pointer";
                    el.onclick = startScenarioMode;
                } else {
                    el.className = "w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center shadow-inner border-4 border-[#F3F4F6] text-gray-300 cursor-not-allowed";
                }
            } else {
                if (isActive) {
                    el.classList.add('active', 'cursor-pointer');
                    if(el.id === 'nav-leaders') el.onclick = loadLeaderboard;
                } else {
                    el.classList.add('text-gray-300', 'cursor-not-allowed');
                }
            }
        }

        function switchView(viewId) {
            ['view-vote', 'view-record', 'view-leaderboard', 'view-success'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- BATTLE ---
        async function loadBattle() {
            if(gameState !== 'voting') return;
            switchView('view-vote');
            document.getElementById('loader').classList.remove('hidden');
            try {
                const response = await fetch(`${API_URL}?action=get-battle`);
                const data = await response.json();
                document.getElementById('loader').classList.add('hidden');
                if (data.skip_voting) {
                    votesDone = VOTES_REQUIRED;
                    gameState = 'recording';
                    updateUI();
                } else {
                    currentRecords = data.records;
                    if (currentRecords[0].topic) document.getElementById('topic-1').innerText = currentRecords[0].topic;
                    if (currentRecords[1].topic) document.getElementById('topic-2').innerText = currentRecords[1].topic;
                    
                    // Force reload audio
                    const a1 = document.getElementById('audio-1');
                    const a2 = document.getElementById('audio-2');
                    a1.src = currentRecords[0].url;
                    a2.src = currentRecords[1].url;
                    a1.load();
                    a2.load();
                }
            } catch (e) {
                console.error(e);
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function vote(winnerIndex) {
            document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
            const winnerCard = document.getElementById(winnerIndex === 0 ? 'card-1' : 'card-2');
            const loserCard = document.getElementById(winnerIndex === 0 ? 'card-2' : 'card-1');
            loserCard.classList.add(winnerIndex === 0 ? 'fly-out-right' : 'fly-out-left');
            const winner = currentRecords[winnerIndex];
            fetch(`${API_URL}?action=vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ winner_id: winner.id })
            });
            setTimeout(() => {
                votesDone++;
                if (votesDone >= VOTES_REQUIRED) {
                    gameState = 'recording';
                    updateUI();
                } else {
                    document.getElementById('card-1').classList.remove('fly-out-left', 'fly-out-right');
                    document.getElementById('card-2').classList.remove('fly-out-left', 'fly-out-right');
                    updateUI();
                    loadBattle();
                }
            }, 500);
        }

        // --- RECORD ---
        function startScenarioMode() {
            if (gameState !== 'recording') return;
            switchView('view-record');
            if (!currentScenarioText) {
                currentScenarioText = SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)];
                document.getElementById('scenario-text').innerText = `"${currentScenarioText}"`;
            }
        }

        const recordBtn = document.getElementById('record-btn');
        recordBtn.addEventListener('click', async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    let options = { mimeType: 'audio/webm' };
                    // iOS fallback logic
                    if (!MediaRecorder.isTypeSupported('audio/webm')) {
                         options = { mimeType: 'audio/mp4' }; 
                         if(!MediaRecorder.isTypeSupported('audio/mp4')) options = undefined;
                    }
                    try { mediaRecorder = new MediaRecorder(stream, options); }
                    catch (e) { mediaRecorder = new MediaRecorder(stream); }

                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                    mediaRecorder.onstop = () => uploadAudio(new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/mp4' })); // Force mp4/webm type
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('mic-icon').classList.replace('fa-microphone', 'fa-stop');
                    recordBtn.classList.add('recording-pulse');
                    document.getElementById('recording-timer').classList.remove('hidden');
                    document.getElementById('rec-hint').innerText = "Нажмите стоп для отправки";
                    let seconds = 0;
                    const timerVal = document.getElementById('recording-timer');
                    timerVal.innerText = "00:00";
                    timerInterval = setInterval(() => {
                        seconds++;
                        timerVal.innerText = `00:${seconds.toString().padStart(2, '0')}`;
                    }, 1000);
                } catch(e) { 
                    alert("Ошибка доступа к микрофону"); 
                }
            } else {
                if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                isRecording = false;
                clearInterval(timerInterval);
                document.getElementById('mic-icon').classList.replace('fa-stop', 'fa-microphone');
                recordBtn.classList.remove('recording-pulse');
                document.getElementById('recording-timer').classList.add('hidden');
                document.getElementById('rec-hint').innerText = "Отправка...";
                tg.MainButton.showProgress();
            }
        });

        async function uploadAudio(blob) {
            const reader = new FileReader();
            reader.readAsDataURL(blob); 
            reader.onloadend = async () => {
                const base64Audio = reader.result;
                const user = tg.initDataUnsafe?.user;
                try {
                    const response = await fetch(`${API_URL}?action=upload`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: user?.id || 999,
                            first_name: user?.first_name || 'Сотрудник',
                            username: user?.username || '',
                            audio_data: base64Audio,
                            mime_type: blob.type,
                            topic: currentScenarioText,
                            city: userCity,    // Send City
                            email: userEmail,  // Send Email
                            avatar_url: user?.photo_url || '' // Send Avatar
                        })
                    });
                    const result = await response.json();
                    tg.MainButton.hideProgress();
                    if (result.status === 'saved') {
                        switchView('view-success');
                    } else {
                        alert("Ошибка: " + (result.error || 'Unknown'));
                    }
                } catch (e) { 
                    tg.MainButton.hideProgress(); 
                    alert("Ошибка сети"); 
                }
            }
        }

        function finishGame() {
            gameState = 'finished';
            updateUI();
        }

        // --- LEADERBOARD ---
        async function loadLeaderboard() {
            if(gameState !== 'finished') return;
            switchView('view-leaderboard');
            const list = document.getElementById('leaders-list');
            list.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-circle-notch fa-spin"></i> Загрузка...</div>';
            try {
                const response = await fetch(`${API_URL}?action=get-leaderboard`);
                const data = await response.json();
                list.innerHTML = '';
                if (!data.leaders || data.leaders.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-400 mt-10">Пока нет записей</div>';
                    return;
                }
                data.leaders.forEach((user, index) => {
                    let medal = '';
                    if(index === 0) medal = '<i class="fas fa-trophy text-yellow-500"></i>';
                    else if(index === 1) medal = '<i class="fas fa-medal text-gray-400"></i>';
                    else if(index === 2) medal = '<i class="fas fa-medal text-[#FF7A00]"></i>';
                    else medal = `<span class="text-gray-400 font-bold">#${index+1}</span>`;

                    // Logic: Use real avatar if available, else generated one
                    let avatarSrc = user.avatar_url;
                    if (!avatarSrc || avatarSrc === "null") {
                        avatarSrc = `https://api.dicebear.com/7.x/initials/svg?seed=${user.name}&backgroundColor=7F00FF,1D1F26,FF7A00`;
                    }

                    const cityBadge = user.city ? `<span class="text-[9px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded ml-1">${user.city}</span>` : '';

                    const row = `
                        <div class="bg-white p-3 rounded-xl card-shadow flex items-center gap-3 border border-gray-100">
                            <div class="w-8 text-center text-lg">${medal}</div>
                            
                            <div class="w-10 h-10 rounded-full bg-gray-100 overflow-hidden shrink-0 border border-gray-200">
                                <img src="${avatarSrc}" class="w-full h-full object-cover">
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex items-center">
                                    <div class="text-sm font-bold text-[#1D1F26] truncate">${user.name}</div>
                                    ${cityBadge}
                                </div>
                                <div class="text-[10px] text-gray-500 truncate mb-1">${user.topic}</div>
                                <audio src="${user.url}" controls preload="none" class="h-6 w-full" style="margin:0;"></audio>
                            </div>
                            
                            <div class="flex flex-col items-center px-2 border-l border-gray-100 min-w-[40px]">
                                <i class="fas fa-heart text-[#7F00FF] text-xs mb-1"></i>
                                <span class="text-sm font-bold text-gray-700">${user.votes}</span>
                            </div>
                        </div>
                    `;
                    list.innerHTML += row;
                });
            } catch(e) { list.innerHTML = '<div class="text-center text-red-400 mt-10">Ошибка загрузки</div>'; }
        }
    </script>
</body>
</html>
